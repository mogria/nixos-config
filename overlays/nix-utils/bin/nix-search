#! /usr/bin/env nix-shell
#! nix-shell -i bash -p jq -p coreutils


CACHE="$HOME/.cache/nix-search-cache"
if ! ( [ -e $CACHE ] && [ $(stat -c %Y $CACHE) -gt $(( $(date +%s) - 60 * 60 * 12 )) ] ); then
    trap "rm $CACHE" SIGKILL SIGTERM
    echo "update cache" && nix-env -qa --json > "$CACHE"
fi

jq -r 'to_entries | .[] | .key + "|" + .value.meta.description' < "$CACHE" | \
{
   if [ $# -gt 0 ]; then
      # double grep because coloring breaks column's char count
      # $* so that we include spaces (could do .* instead?)
        grep -i "$*" | column -t -s "|" | grep --color=always -i "$*"
   else
        column -t -s "|"
   fi
}

